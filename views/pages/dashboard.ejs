<%- include('../partials/header') %>

    <div class="admin-dashboard">
        <h1>
            Bienvenue<% if (user && user.firstname) { %>
                <%= user.firstname %>
                    <% } %>
        </h1>
        <p>Ceci est une page protégée.</p>
        <a href="/logout" class="logout-btn">Se déconnecter</a>
    </div>

    <!-- Bouton pour afficher/masquer tout le bloc concerts -->
    <button type="button" class="dashboard-toggle" onclick="toggleConcertsSection()" id="concerts-toggle-btn"
        aria-expanded="false">
       Gestion des Concerts
        <span class="toggle-arrow" id="concerts-arrow">&#9654;</span>
    </button>



    <!-- Bloc caché par défaut -->
    <div id="concerts-section" style="display: none;">
        <div class="add-concert-form">
            <h2>Ajouter un nouveau concert</h2>
            <form class="concert-form" action="/concerts" method="POST">
                <div class="form-group">
                    <label for="artist">Nom de l'artiste</label>
                    <input type="text" id="artist" name="artist" placeholder="Nom de l'artiste" required>
                </div>
                <div class="form-group">
                    <label for="image_url">Lien de l'image (URL)</label>
                    <input type="url" id="image_url" name="image_url" placeholder="https://...">
                    <small>Copie-colle l’URL d’une image ou d’une affiche (optionnel).</small>
                </div>
                <div class="form-group">
                    <label for="venue">Lieu</label>
                    <input type="text" id="venue" name="venue" placeholder="Lieu" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">Heure</label>
                        <input type="time" id="time" name="time">
                    </div>
                </div>
                <div class="form-group">
                    <label for="phone">Téléphone pour réserver (facultatif)</label>
                    <input type="tel" id="phone" name="phone" placeholder="06 12 34 56 78">
                </div>
                <div class="form-group">
                    <label for="price">Prix (€)</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" placeholder="Prix">
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3" placeholder="Description"></textarea>
                </div>
                <button type="submit" class="btn-primary">Ajouter le concert</button>
            </form>
        </div>

        <div class="concerts-admin-list">
            <h2>Aperçu des concerts</h2>
            <% if (concerts.length===0) { %>
                <p>Aucun concert enregistré pour l’instant.</p>
                <% } else { %>
                    <div class="concerts-admin-cards">
                        <% concerts.forEach(concert=> { %>
                            <div class="concert-admin-card">
                                <div class="concert-card-header">
                                    <span class="concert-date">
                                        <% let dateStr='' ; if (concert.concert_date) { if (typeof
                                            concert.concert_date==='object' && concert.concert_date.toLocaleDateString)
                                            { dateStr=concert.concert_date.toLocaleDateString(); } else if (typeof
                                            concert.concert_date==='string' ) { const
                                            parts=concert.concert_date.split('-'); if (parts.length===3)
                                            dateStr=`${parts[2]}/${parts[1]}/${parts[0]}`; else
                                            dateStr=concert.concert_date; } } %>
                                            <%= dateStr %>
                                                <% if (concert.concert_time) { %>
                                                    à <%= String(concert.concert_time).slice(0,5).replace(':','h') %>
                                                        <% } %>
                                    </span>
                                    <span class="concert-venue">
                                        <%= concert.venue %>
                                    </span>
                                </div>
                                <div class="concert-admin-info">
                                    <h3 class="concert-artist">
                                        <%= concert.artist_name %>
                                    </h3>
                                    <% if (concert.description) { %>
                                        <p class="concert-description">
                                            <%= concert.description %>
                                        </p>
                                        <% } %>
                                            <div class="concert-admin-actions">
                                                <form action="/concerts/<%= concert.id %>?_method=DELETE" method="POST"
                                                    style="display:inline;">
                                                    <button type="submit" class="btn-delete">Supprimer</button>
                                                </form>
                                                <button type="button" class="btn-edit"
                                                    onclick="toggleEditForm('<%= concert.id %>')">Modifier</button>
                                            </div>
                                            <!-- Formulaire d'édition inline (masqué par défaut) -->
                                            <form class="edit-concert-form" id="editForm-<%= concert.id %>"
                                                action="/concerts/<%= concert.id %>" method="POST"
                                                style="display:none; margin-top:12px;">
                                                <div class="form-group">
                                                    <label for="edit-artist-<%= concert.id %>">Artiste</label>
                                                    <input type="text" id="edit-artist-<%= concert.id %>" name="artist"
                                                        value="<%= concert.artist_name %>" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-venue-<%= concert.id %>">Lieu</label>
                                                    <input type="text" id="edit-venue-<%= concert.id %>" name="venue"
                                                        value="<%= concert.venue %>" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-date-<%= concert.id %>">Date</label>
                                                    <input type="date" id="edit-date-<%= concert.id %>" name="date"
                                                        value="<%= concert.concert_date.toISOString ? concert.concert_date.toISOString().slice(0,10) : concert.concert_date %>"
                                                        required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-time-<%= concert.id %>">Heure</label>
                                                    <input type="time" id="edit-time-<%= concert.id %>" name="time"
                                                        value="<%= concert.concert_time ? concert.concert_time.slice(0,5) : '' %>">
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-price-<%= concert.id %>">Prix (€)</label>
                                                    <input type="number" id="edit-price-<%= concert.id %>" name="price"
                                                        step="0.01" min="0" value="<%= Number(concert.ticket_price) %>">
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-phone-<%= concert.id %>">Téléphone</label>
                                                    <input type="tel" id="edit-phone-<%= concert.id %>" name="phone"
                                                        value="<%= concert.phone %>">
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-image-<%= concert.id %>">Image URL</label>
                                                    <input type="url" id="edit-image-<%= concert.id %>" name="image_url"
                                                        value="<%= concert.image_url %>">
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit-description-<%= concert.id %>">Description</label>
                                                    <input type="text" id="edit-description-<%= concert.id %>"
                                                        name="description" value="<%= concert.description %>">
                                                </div>
                                                <button type="submit" class="btn-primary btn-xs">Valider</button>
                                                <button type="button" class="btn-cancel btn-xs"
                                                    onclick="toggleEditForm('<%= concert.id %>', true)">Annuler</button>
                                            </form>
                                </div>
                            </div>
                            <% }); %>
                    </div>
                    <% } %>
        </div>
    </div>

    <%- include('../partials/footer') %>

        <!-- JS pour afficher/masquer le bloc concerts -->